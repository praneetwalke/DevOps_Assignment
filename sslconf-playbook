---
- name: Secure the demo site with SSL using the self-signed certificate
  hosts: webserver
  become: yes
  tasks:
    - name: Enable SSL and rewrite modules in Apache
      command: a2enmod ssl
      notify: restart apache

    - name: Enable Apache rewrite module
      command: a2enmod rewrite
      notify: restart apache

    - name: Configure SSL in Apache
      copy:
        content: |
          <VirtualHost *:443>
              ServerAdmin webmaster@localhost
              DocumentRoot /var/www/html
              SSLEngine on
              SSLCertificateFile /etc/ssl/certs/selfsigned.crt
              SSLCertificateKeyFile /etc/ssl/private/selfsigned.key
              <Directory /var/www/html>
                  Options -Indexes
                  AllowOverride All
              </Directory>
              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
        dest: /etc/apache2/sites-available/default-ssl.conf
      notify: restart apache

    - name: Enable default SSL site in Apache
      command: a2ensite default-ssl.conf
      notify: restart apache

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted
